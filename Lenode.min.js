export default class Lenode{constructor(e={},t=!1,s,i){if("Lenode"!==new.target.name&&(this._class=new.target.name),this._name=s||this._class,Lenode.isNode(e))this._node=e,this._tag=e.tagName.toLowerCase(),[...e.children].forEach(e=>new Lenode(e,!1,e.tagName,this)),!this._name&&(this._name=e.tagName.toLowerCase()),i&&(this.parent=i);else{var r=s?s.replace(/\./g,"_").split("_"):[];this._tag=Array.isArray(e)?"ul":r.length>1?r.shift():"div",this._class&&!r.includes(this._class)&&r.push(this._class),this._node=Lenode.createNode(this._tag,r,i?i._node:null),"string"==typeof e?e.endsWith(".json")?this.buildJSON(e):this.build({_html:e}):this.build(e),i&&i.replaceChild(this,this._name)}this._id=isNaN(document.lenodeIndexer)?document.lenodeIndexer=0:document.lenodeIndexer+=1,this._style=this.addStyle(t)}setup(){}end(){}add(e,t,s=!1){var i;return e&&e._isLenode&&e._parent!==this?(this[e._name]&&this[e._name].remove(),!t||(e._name=t),this._node[s?"prepend":"appendChild"](e._node),e._parent&&(e._parent[e._name]=void 0),e._parent=this,i=e,t?e.addClass(t):t=e._name):(i=Lenode.nodify(e,this._list?"li_item":t,this,s))&&i._node&&(i._parent=this,i._list&&i._list.forEach((e,t)=>e._index=t)),Array.isArray(this._list)?(i._index=this._list.length,this._list.push(i),i):this[t]=i}addStyle(e){if(e){if(!this._class&&this.setAttribute("class",this._class="lenode-"+this._id),!0===e)return document.lehead.addResource(`css/${this._class}.css`);if("string"==typeof e&&e.endsWith(".css"))return document.lehead.addResource(e);var t={_html:Lenode.stylize(e,this._class),_tag:"style",_type:"text/css"};return document.lehead?document.lehead.replaceChild(t,"style_"+this._class):this.replaceChild(t,"style_"+this._class,!0)}}build(e={},t){return this._html="",Array.isArray(e)?this._list=e.map(e=>Lenode.nodify(e,"li_item",this)):Object.keys(e).forEach(t=>this.add(e[t],t)),t&&this.addStyle(t),this}replace(e){return this._parent?this._parent.replaceChild(e,this):null}replaceChild(e,t,s=!1){var i=t&&"string"==typeof t?t:t?t._name:e._name?i=e._name:null;if(!this[i]||!this[i]._node)return this.add(e,i,s);var r=this[i]._node;return(t=e._isLenode?e:Lenode.nodify(e,i,this))._name!==i&&(t.addClass(i)._name=i),this._node.insertBefore(t._node,r),r.remove(),t._parent=this,this[i]=t}remove(){this._node.remove(),this._style&&this._style.remove(),this.parent&&delete this.parent[this._name]}update(e={}){return this.parent.replaceChild(e,this._name)}addJSON(e,t,s,i=!1){return Lenode.getJSON(e,s).then(e=>{e=this.add(e,t,i);return this.setup(),e})}buildJSON(e,t,s){return Lenode.getJSON(e,t).then(e=>{e=this.build(e);return s?s():this.setup(),e})}updateJSON(e,t,s){return Lenode.getJSON(e,t).then(e=>{e=this.update(e);return s?s():this.setup(),e})}get _children(){return Array.isArray(this._list)?this._list:Object.keys(this).map(e=>this[e]).filter(e=>e&&e._isLenode)}transfer(e,t){if(!Array.isArray(this._list))return this;var s=this._list.splice(this._list.reduce((t,s)=>null!==t?t:s===e?s._index:null,null),1)[0];return t&&t.add(s),this.refresh()}refresh(){return Array.isArray(this._list)?([...this._node.querySelectorAll("li")].forEach(e=>e.remove()),this._list.forEach((e,t)=>{e._index=t,e._parent=this,this._node.appendChild(e._node)}),this):this}shuffle(){if(!Array.isArray(this._list))return this;var e=[];return this._list.forEach(t=>e.splice(Math.round(Math.random()*e.length),0,t)),this._list=e,this.refresh()}itemAt(e){return Array.isArray(this._list)?this._list[e]:null}forEach(e){return this._list.forEach(e)}map(e){return this._list.map(e)}reduce(e){return this._list.reduce(e)}filter(e){return this._list.filter(e)}get _length(){return this._list.length}getStyle(e){return this._node.style[e]}setStyle(e,t){return this._node.style[e]=t,this}setStyles(e={}){return Object.keys(e).forEach(t=>this.setStyle(t,e[t])),this}hasClass(e){return this._node.classList.contains(e)}addClass(e,t=!1){return this.setClass(e,!0,t)}removeClass(e,t=!1){return this.setClass(e,!1,t)}toggleClass(e,t=!1){return this.setClass(e,!this.hasClass(e),t)}setClass(e,t=!0,s=!1){return s&&(this._node.style.transition="number"==typeof s?`${s}s`:s),e=Array.isArray(e)||"string"!=typeof e?[]:e.split(" "),t?this._node.classList.add(...e):this._node.classList.remove(...e),this}flashClass(e,t=1,s=null,i=!1){return this.addClass(e,i),setTimeout(t=>{this.removeClass(e),"function"==typeof s&&s()},1e3*t),this}runClasses(e,t=1,s,i=!1){if(e&&e.length){var r=e.shift();if(r)return e.length?this.flashClass(r,t,this.runClasses(e,t,s,i),i):(this.addClass(r,i),s&&s()),this}}handleEvent(e,t){this._node[e]=(e=>{e.stopPropagation(),t(e)})}set onclick(e){this.handleEvent("onclick",()=>e(this))}set onchange(e){this.handleEvent("onchange",()=>e(this))}set onblur(e){this.handleEvent("onblur",()=>e(this))}click(){return this._node.click()}querySelector(e){return this._node.querySelector(e)}querySelectorAll(e){return this._node.querySelectorAll(e)}setAttribute(e,t){return this._node.setAttribute(e,t)}getAttribute(e){return this._node.getAttribute(e)}get _attributes(){var e=this._node.attributes,t={};return Object.keys(e).map(s=>t[e[s].name]=e[s].value),t}set _html(e){this._node.innerHTML=e}set _text(e){this._node.innerText=e}set _value(e){this._node.value=e}get _html(){return this._node.innerHTML}get _text(){return this._node.innerText}get _value(){return this._node.value}get _isLenode(){return Lenode.isNode(this._node)}static app(e){return new Lehead(e)}static nodify(e={},t,s,i=!1){if(null==e||"_tag"===t)return;if(Lenode.isNode(e))return new Lenode(e,!1,t,s);t||console.log(e);const r=t.startsWith("_");var n=Array.isArray(e)?"ul":e._tag?e._tag:["header","main","footer","style"].includes(t)||r?t:"div",a=r?null:t,o=a,h=t.replace(/([A-Z])/g,"_$1").toLowerCase().split("_");if(!r&&!e._tag&&h.length>1&&(n=h.shift(),o=[a=h.pop(),...h]),delete e._tag,r&&s)return!["_html","_text"].includes(n)&&("_class"===t?s.addClass(e):s.setAttribute(t.replace(/\_/g,""),e)),s[t]=e;if(["boolean","number","string"].includes(typeof e)){var d=this.createNode(n,o,s._node,{},i);return d.innerHTML=e,new Lenode(d,!1,t,this,i)}["script","link","meta","style"].includes(n)&&(o=null);var l=new Lenode(this.createNode(n,o,s._node,{},i),!1,t,s);return this._name=t,"ul"===n?l._list=e.map(e=>Lenode.nodify(e,"li_item",l)):Object.keys(e).forEach(t=>l.add(e[t],t)),l}static stylize(e,t){if(e){if("string"==typeof e)return e;!t&&(t=new.target?new.target.name:this._name);var s=(t=t.replace(/([A-Z])/g,".$1").toLowerCase()).startsWith(".")?t:"."+t;if(t.includes("@media")){var i=t.indexOf("@media");return s+=" {\n",Object.keys(e).forEach(r=>{s+=Lenode.stylize(e[r],t.substr(0,i)+r.replace(/__/g," .").replace(/_/g,".").replace(/\$/g,":").replace(/&/g,""))}),s+="}\n"}return s+=" {\n",Object.keys(e).forEach(t=>{["string","number"].includes(typeof e[t])?(s+="  "+t.replace(/([A-Z])/g,"-$1").toLowerCase()+": "+e[t]+";\n",delete e[t]):t.includes(",")&&(t.split(",").map(e=>e.trim()).forEach(s=>Lenode.assign(e[s]?e[s]:e[s]={},e[t])),delete e[t])}),s+="}\n",Object.keys(e).forEach(i=>{var r=".:_$>&".includes(i.charAt(0))?"":" ";s+=Lenode.stylize(e[i],t+r+i.replace(/__/g," .").replace(/_/g,".").replace(/\$/g,":").replace(/&/g,""))}),s}}static link(e,t,s=!0,i="_blank"){return e.startsWith("http")&&(s=!1),!t&&(t=e),s?`<a onclick=lehead.goto("${e}")>${t}</a>`:`<a href="${e}" target="${i}">${t}</a>`}static createNode(e="div",t,s,i={},r=!1){var n=document.createElement(e);if(Lenode.isNode(n))return t&&(n.className=Array.isArray(t)?t.join(" "):t),s&&s[r?"prepend":"appendChild"](n),Object.keys(i).forEach(e=>n.setAttribute(e,i[e])),n}static assign(e,t){if(!t)return e;var s={},i=Object.keys(t).filter(e=>!["string","number","boolean"].includes(typeof t[e])||(s[e]=t[e])&&!1);return Object.assign(e,s),i.forEach(s=>Lenode.assign(e[s]?e[s]:e[s]={},t[s])),e}static isNode(e){try{return e instanceof HTMLElement}catch(t){return"object"==typeof e&&1===e._nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument}}static getJSON(e,t){return fetch(e).then(e=>e.text()).then(e=>JSON.parse(e)).then(e=>t?e.map(t):e)}}export class Lehead extends Lenode{constructor(e={}){super(document.head);const t=this._attributes;this._args=[],this._count=1,this._data={},this._pages=e.pages?e.pages:t.pages,this._home=e.homepage?e.homepage:t.homepage?t.homepage:"home",this.body=e.body?e.body:t.body;var s=e.title?e.title:t.title;!this.body._isLenode&&(this.body=new Lenode(this.body)),s&&this.add(s,"title_site");var i=e.icon?e.icon:t.icon;i&&this.addResource(i.endsWith(".png")?i:`${i}.png`),(e.noscale?e.noscale:"string"==typeof t.noscale)||this.add({_tag:"meta",_name:"viewport",_content:"width=device-width,initial-scale=1,shrink-to-fit=no"},"viewport");var r=e.styles?e.styles:[];t.styles&&(r=[...r,...t.styles.split(" ")]),r.forEach((e,t)=>{(e=e.trim()).search("{")>-1?this.add({_tag:"style",_html:e,_type:"text/css"},`style_${t}`):this.addResource(e.search(/.css|http/)>-1?e:`${e}.css`,"css")});var n=e.scripts?e.scripts:[];t.scripts&&(n=[...n,...t.scripts.split(" ")]),n.forEach(e=>{e=e.trim(),this.addResource(e.endsWith(".js")?e:`${e}.js`,"js")}),document.lehead=this,document.lebody=new Lenode(document.body),this.loadNode(this.body),window.addEventListener("popstate",()=>this.getQuery()),this.getQuery()}getId(){return this._count+=1}addResource(e,t){t=t||e.split(".").pop();const s=e.replace(/\/|\./g,"_");var i={};return"js"===t?i._src=e:i._href=e,i._tag="js"===t?"script":"link",i._type="js"===t?"text/javascript":"css"===t?"text/css":"png"===t?"image/png":null,"css"===t?i._rel="stylesheet":"png"===t&&(i._rel="icon"),this.replaceChild(i,s)}addPage(e,t){if(!t&&e._name&&(t=e._name),!t)return console.log("Page needs a name to be added");this._pages[t]=e,this.getQuery()}addModule(e,t=!0){if(!this._src){if(this._src=this._attributes.src,!this._src){var s=null;["Lehead","app","App","index"].filter(e=>!s&&(s=this.querySelector(`script[src$="${e}.js"]`))),this._src=s?s.getAttribute("src").split("/")[0]:"src"}!this._src.endsWith("/")&&(this._src+="/")}const i=t?`new ${e}()`:`document.lehead.setPage(new ${e}())`,r=this.replaceChild({_tag:"script",_type:"module",_html:`import ${e} from './${this._src+e}.js'; ${i};`},e);return t?this._pageModule=r:r}loadNode(e,t=!0){return e||this.setPage(),e._isLenode?this.setPage(e):"function"==typeof e?this.loadNode(new e):"string"!=typeof e?this.loadNode(new Lenode(e)):this._pages[e]?this.loadNode(this._pages[e]):(this.setPage(new Lenode({p_message:`Cannot access <b>${e}</b> page.`})),void this.addModule(e,t))}setPage(e){if(e?!e._isLenode&&(e=new Lenode(e)):e=new Lenode({}),e!==this.body)return document.lepage=document.lebody.main.replaceChild(e,"page");!e.main&&e.add({},"main"),e._children.forEach(e=>document.lebody.add(e)),this.body=document.lebody.addClass(e._class),document.lepage&&document.lehead.route(document.lepage._name)}goto(e){if(this._pageName!==e){var t=document.lepage&&document.lepage.end?document.lepage.end():0;return setTimeout(()=>this.route(e),1e3*t),this}}route(e){if(e?(this._args=e.split("/"),e=this._args.shift()):("function"==typeof(e=this._home)&&(e=e.name),this._args=[]),this._pageName!==e&&e){var t=window.location.protocol+"//"+window.location.host+window.location.pathname+`?${e}`+"/"+this._args.join("/");window.history.pushState({path:t},"",t),this._pageModule&&this._pageModule.remove&&this._pageModule.remove(),this._pageName=e,this.loadNode(e)}}getQuery(e){var t,s=window.location.href.split("?")[1];return s&&(this._args=s.split("/"),t=this._args.shift()),!t&&(t=this._home),t!==(document.lepage?document.lepage._name:null)?this.goto(t):new Lebody,t}setCookie(e,t,s=30){var i=new Date;i.setTime(i.getTime()+24*s*60*60*1e3);var r="expires="+i.toUTCString();document.cookie=`${e}=${t};${r};path=/`}getCookie(e){e+="=";var t=decodeURIComponent(document.cookie).split(";").filter(t=>t.trim().startsWith(e))[0];return t?t.substr(e.length):""}}